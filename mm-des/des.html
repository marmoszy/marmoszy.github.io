<head>
  <title>DES v1.0</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body, input, pre, button, textarea, a, div {
   font-size: 18px;
  }
  input {
	 padding: 10px;
	 padding-left: 20px;
	 padding-right: 20px;
     background-color: steelblue;
     font-size: 20px;
  }
  h1,h2,h3 {
	  color: steelblue;
	  font-weight: normal;
  }
</style>
<head>

<center>
	<h1>DES - Descrete Event (micro) Simulator</h1>
	<p>MM February 2024</p>
</center>

<script>
ex1=`
# Two sequential tasks
1 Start(E,[2.0],20.0)  # 20 units of exponential events with mean of 2 time units
2 Task(U,[2.0,3.0])    # a task with execution time from 2 to 3 units
3 Task(U,[1.0,3.0])
4 End()
1->2; 2->3; 3->4
`
ex2=`
# A process with two parallel tasks
1 Start(E,[2.0],20.0)
2 AndGate()
3 Task(U,[2.0,3.0]) 
4 Task(U,[1.0,3.0])
5 AndGate()
6 End()
1->2; 2->3; 2->4; 3->5; 4->5; 5->6;
`
ex3=`
# A process with sequential and parallel tasks
1 Start(E,[1.0],20.0)
2 Task(E,[2.0]) 
3 Task(E,[3.0])
4 AndGate()
5 Task(U,[1.0,2.0])
6 Timer(1.0)
7 AndGate() 
8 End()
1->2; 2->3; 3->4; 4->5; 5->7; 4->6; 6->7; 7->8
`
ex4=`
# Two doctors
1 Start(E,[2.0],-20.0)
2 XorGate("=B(0.5)")
3 XorGate()
4 XorGate()
5 Task(U,[2.0,3.0],"tsk1=1")
6 Task(U,[1.0,3.0],"tsk2=1")
7 XorGate("=(tsk2==1)")
8 XorGate("=(tsk1==1)")
9 XorGate()
10 End()
1->2; 2->3; 2->4; 3->5; 4->6; 5->7; 6->8; 7->9; 7->4; 8->9; 8->3; 9->10
`
ex5=`
# Bikeshare
1 Start(E,[2.0],-100.0,"S.bA=3")       # start with 3 bikes in A
2 Start(E,[2.0],-100.0,"S.bB=3")       # start with 3 bikes in B
3 XorGate("=S.bA>0;S.bA=S.bA>0 and S.bA-1 or 0")  # any bike in A?; yes: take it
4 XorGate("=S.bB>0;S.bB=S.bB>0 and S.bB-1 or 0")  # any bike in B?; yes: take it
5 Timer(U,[4.0,5.0],"S.bB=S.bB+1")     # ride and leave taken bike at B
6 Timer(U,[15.0,20.0])                 # walk to B
7 Timer(U,[4.0,5.0],"S.bA=S.bA+1")     # ride and leave taken bike at A
8 Timer(U,[15.0,20.0])                 # walk to A
9 End()                                # end of riding from A to B
10 End()                               # end of walking from A to B
11 End()                               # end of riding from B to A
12 End()                               # end of walking from B to A
1->3; 2->4; 3->5; 3->6; 4->7; 4->8; 5->9; 6->10; 7->11; 8->12
`
ex6=`
# Timer test
1 Start(U,[2.0],6)
2 Timer(3.0)            # delay all events by 3.0  
3 End()
1->2; 2->3
`
ex7=`
# An activity variable test (A.n - client number)
1 Start(U,[2.0],-100.0) # hundread events every 2 time units
2 XorGate("=(A.n-1)%2") # switch every second to different task
3 Task(U,[3.0])
4 Task(U,[3.0])
5 End()
6 Terminate()
1->2; 2->3; 2->4; 3->5; 4->6;
`
ex8=`
# A four phases process
1 Start(E,[2.0],20.0)
2 Task(U,[2.0,3.0])
3 Throw()
4 Throw()
5 End()
6 AndGate()
7 Task(U,[1.0,3.0])
8 Task(U,[1.0,3.0])
9 Task(U,[1.0,3.0])
10 Task(U,[1.0,3.0])
11 AndGate()
12 XorGate("=C([0.33,0.34,0.33])")
13 Task(U,[1.0,3.0])
14 Task(U,[1.0,3.0])
15 Task(U,[1.0,3.0])
16 XorGate()
17 Timer(1.0)
18 Script("print('Task 17 times for %s: %.2f %.2f %.2f'%(cname,__t17a,__t17b,__t17e))")
19 End()
1->2; 2->4; 4->6; 6->7; 6->8; 6->9; 6->10; 7->11; 8->11; 9->11; 10->11; 11->12; 12->13; 12->14; 12->15; 13->16; 14->16; 15->16; 16->17; 17->18; 18->19; 1->3; 3->5;
`
ex9=`
# Condition test: from three parallel tasks only two could be executed as only two resources are available
1 Start(E,[2.0],20.0,"S.x=2")     # two abstract resources
2 XorGate("=(A.n-1)%3")           # pass to 3 lines
3 Condition("=S.x>0;S.x=S.x-1")   # check availability and decrement if available
4 Condition("=S.x>0;S.x=S.x-1")   # ...
5 Condition("=S.x>0;S.x=S.x-1")   # ...
6 Task(U,[2.0,4.0],"S.x=S.x+1")   # release resource when finished
7 Task(U,[3.0,4.0],"S.x=S.x+1")   # ...
8 Task(U,[3.0,5.0],"S.x=S.x+1")   # ...
9 XorGate()
10 End()
1->2; 2->3; 2->4; 2->5; 3->6; 4->7; 5->8; 6->9; 7->9; 8->9; 9->10;
`
ex10=`
# Credit card application - time in 10min units
1 Start(E,[1],-40)      # 2 clerks (25$/h), 3 credit officers (50$/h) 
2 AndGate()
3 Task(N,[1,2/10])      # check credit history (clerk)
4 Task(N,[2,4/10])      # check income sources  (clerk)
5 AndGate()
6 XorGate()
7 Task(E,[2])           # assess application (credit officer)
8 XorGate("=B(0.8)")    # decission review requested (20/80)
9 Task(N,[1,2/10])      # make credit offer  (credit officer)
10 Task(N,[1,2/10])     # notify rejection   (credit officer)
11/10/1 End()
12 XorGate("=B(0.8)")   # notify rejection (20/80)
13 End()
1->2; 2->3; 2->4; 3->5; 4->5; 5->6; 6->7; 7->8; 8->9; 8->10; 9->11; 10->12; 12->13; 12->6
`
ex11=`
# G/G/2 test  
1 Start(U,[1],-20)       
2 AndGate()
3 Task(U,[4])       # G/G/1
4 Task(U,[4],"",2)  # G/G/2
5 Task(U,[4])       # G/G/1
6 Task(U,[4],"",2)  # G/G/2
7 End()
8 End()
1->2; 2->3; 2->4; 3->5; 4->6; 5->7; 6->8
`
ex12=`
# Procurement Process 
1 Start(E,[1],-40)      
2 Task(N,[1,2/10])      # handle quotation
3 Task(N,[2,4/10])      # approve order
4 XorGate()             # approved/not approved
5 AndGate()             # approved trajectory
6 Terminate()           # not approved trajectory
7 Task(E,[2])           # handle order
8 Task(E,[2])           # handle shipment
9 AndGate()             # 
10 Task(N,[1,2/10])     # review order
11 End()
1->2; 2->3; 3->4; 4->5; 4->6; 5->7; 5->8; 7->9; 8->9; 9->10; 10->11;
`
ex13=`
# Order (one time unit -> 5 min)
1 Start(U,[2],-20.0,"S.r=100")      # 20 orders            # every 2 time units, 100 resources available
2 Task(T,[1,3],"o=int(N([10,3]))")  # order registration   # 5-15 min, normally order of 10 resources
3 AndGate()                         #                      # split into two parallel paths
4 Task(T,[1,3])                     # invoice preparation  # 5-15 min
5 Task(T,[3,4])                     # check availability   # 15-20 min
6 XorGate("=B(0.9)")                # correction needed?   # 90% is good
7 Timer(U,[8,16])                   # correction request
8 Task(T,[1,2])                     # invoice corrected
9 XorGate()                         #                      # joins XorGate 6
10 Timer(T,[0,14])                  # payment request
11 Task(T,[1,2])                    # payment registration # 5-10 min
12 AndGate()
13 XorGate("=(S.r>=o)")             # available?
14 Task(T,[3,4],"S.r=S.r-o")        # product packaging    # 15-20 min
15 AndGate() 
16 Task(T,[4,6])                    # order from supplier
17 AndGate()
18 Timer([40,24],"S.r=S.r+100")     # wait for delivery    # every 40 since 24
19 Task(T,[4,6],"S.r=S.r-o")        # repackaging          # 20-30 min
20 Task(T,[4,6])                    # preparation for shipment
21 Timer(U,[16,24])                 # delivery               
22 End()                            # order completed
23 Task(T,[1,2])                    # info to customer     # 5-10 min
24 XorGate("=B(0.1)")               # not accepted?        # 10% do not accept
25 Task(T,[1,2])                    # refund and cancel
26 XorGate()
27 Terminate()
1->2; 2->3; 3->4; 4->6;                   6->9;   9->10; 10->11;         11->12; 12->20; 20->21; 21->22;
                          6->7;   7->8;   8->9;                          
            3->5; 5->13; 13->14;                                 14->26; 26->12; 
                         13->15; 15->16; 16->17; 17->18; 18->19; 19->26;  
                                 15->23; 23->24; 24->25; 24->17; 25->27; 
`
</script>
Implementation of Descrete Event Simulator with a BPMN-like events. The simulator uses text-defined processes for its execution.
The results are in form of a text description that represents the content of all End events and timeline for each event in the form of a sequence chart.
 
<h2>Implemented BPMN Events:</h2>
<ol>
	<li>Start(fun, param, tnmax, script) - start event
	<li>Task(fun, param, script, nservers=1) - sequential task activity with nservers inside
	<li>XorGate(script) - exclusive gateway (two-output: value==true passes the event to the first defined connection, value==false - to the second (more than two: must have algebraic choice-like function with results as a number starting from 0) multi-input: pass trought the event from all connected)
	<li>AndGate(script) - parallel gateway (multi-output: passes through the event to all connected, multi-input: waits for all)
	<li>Timer(fun, param, script) - timer delay event
	<li>Condition(script) - conditional event with a script containing logical expresion as the first one ("=&lt;expr&gt;;..."); the instructions after first semicolon will be executed only when condition evaluats to true
	<li>End() - end event
</ol>
where:
<ol>
	<li>fun - random functions: E([mean]), N([mean,std]), U([min,max]), T([min,max,mean,std]), B(p), C([p1,p2,p3,...]), None 
	<li>param - array of fun params (fun==None: deterministic time delay in param[0])
	<li>tnmax - tnmax&gt;	0: maximum time for start generator; tnmax&lt;0: -tnmax represents maximum number of generated events
	<li>script - string with semicolon separated codes for evaluation during event execution "[var]=&lt;expr&gt;; ... ;", empty var defaults to 'value' variable which is tested in XorGate and Condtion, var starting with 'S.' are scenario ones, starting with 'A.' event ones and without prefix - token/customer ones. Variable 'A.n' is event counter which is initiated with 0 and increased by 1 at exec of each token/customer event. Token/customer have variable 'cname' (customer name) and may have variables '__t&lt;id&gt;a', '__t&lt;id&gt;b' and '__t&lt;id&gt;e' when the token visited event with identifier id. They mark arrival, begin and end times.
</ol>
The text description of a process contains list of events that should be ordered by number (event identifier) and a semicolon separated list of connections (see examples below). As a result the bpmn and svg schematic are generated. 
<p>
The events should be numbered using left to right rule. It allows for using simple automatic layout algorithm for pressentation (which is not perfect). In case of presentce of overlaying elements in final diagram it is possible to force position of an element by adding slash-separated '/x[/y]' values after event identifier (see example 10). Moreover, one-line description of connections could be split into multi-line one and then the first appearance of event number in the connection forces the y position of the element to be according to line sequence.
 <p>
The off-line version which is not available from web interface, allows for running simulations multiple times for statistic analysis. 

<h2>Examples:</h2>
<ol>
	<h3><li>A process with two serial tasks</h3>
		<pre id="ex1"><script>document.getElementById("ex1").innerHTML=ex1;</script></pre>
		<br><object type="image/svg+xml" data="ex1_bpmn.svg"></object>
		<br><object type="image/svg+xml" data="ex1_des.svg"></object>
	<h3><li>A process with two parallel tasks</h3>
		<pre id="ex2"><script>document.getElementById("ex2").innerHTML=ex2</script></pre>
		<br><object type="image/svg+xml" data="ex2_bpmn.svg"></object>
		<br><object type="image/svg+xml" data="ex2_des.svg"></object>
	<h3><li>A process with serial and parallel tasks</h3>
		<pre id="ex3"><script>document.getElementById("ex3").innerHTML=ex3</script></pre>
		<br><<object type="image/svg+xml" data="ex3_bpmn.svg"></object>
		<br><object type="image/svg+xml" data="ex3_des.svg"></object>
	<h3><li>A process with two parallel tasks both must be executed</h3>
		<pre id="ex4"><script>document.getElementById("ex4").innerHTML=ex4</script></pre>
		<br><object type="image/svg+xml" data="ex4_bpmn.svg"></object>
		<br><object type="image/svg+xml" data="ex4_des.svg"></object>
	<h3><li>A bicycle sharing systems</h3>
		<pre id="ex5"><script>document.getElementById("ex5").innerHTML=ex5</script></pre>
		<br><object type="image/svg+xml" data="ex5_bpmn.svg"></object>
		<br><object type="image/svg+xml" data="ex5_des.svg"></object>
	<h3><li>A timer test</h3>
		<pre id="ex6"><script>document.getElementById("ex6").innerHTML=ex6</script></pre>
		<br><object type="image/svg+xml" data="ex6_bpmn.svg"></object>
		<br><object type="image/svg+xml" data="ex6_des.svg"></object>
	<h3><li>An event variable test</h3>
		<pre id="ex7"><script>document.getElementById("ex7").innerHTML=ex7</script></pre>
		<br><object type="image/svg+xml" data="ex7_bpmn.svg"></object>
		<br><object type="image/svg+xml" data="ex7_des.svg"></object>
	<h3><li>A four phases process</h3>
		<pre id="ex8"><script>document.getElementById("ex8").innerHTML=ex8</script></pre>
		<br><object type="image/svg+xml" data="ex8_bpmn.svg"></object>
		<br><object type="image/svg+xml" data="ex8_des.svg"></object>
	<h3><li>A conditional event example with abstract resource</h3>
		<pre id="ex9"><script>document.getElementById("ex9").innerHTML=ex9</script></pre>
		<br><object type="image/svg+xml" data="ex9_bpmn.svg"></object>
		<br><object type="image/svg+xml" data="ex9_des.svg"></object>
	<h3><li>Credit card application</h3>
		<pre id="ex10"><script>document.getElementById("ex10").innerHTML=ex10</script></pre>
		<br><object type="image/svg+xml" data="ex10_bpmn.svg"></object>
		<br><object type="image/svg+xml" data="ex10_des.svg"></object>
	<h3><li>G/G/2 queue test</h3>
		<pre id="ex11"><script>document.getElementById("ex11").innerHTML=ex11</script></pre>
		<br><object type="image/svg+xml" data="ex11_bpmn.svg"></object>
		<br><object type="image/svg+xml" data="ex11_des.svg"></object>
	<h3><li>Procurement process</h3>
		<pre id="ex12"><script>document.getElementById("ex12").innerHTML=ex12</script></pre>
		<br><object type="image/svg+xml" data="ex12_bpmn.svg"></object>
		<br><object type="image/svg+xml" data="ex12_des.svg"></object>
	<h3><li>Order process</h3>
		<pre id="ex13"><script>document.getElementById("ex13").innerHTML=ex13</script></pre>
		<br><object type="image/svg+xml" data="ex13_bpmn.svg"></object>
		<br><object type="image/svg+xml" data="ex13_des.svg"></object>
</ol>

<h2>Running code: </h2>
<input type=button onclick='document.getElementById("in").value=ex1.substring(1);' value="1." />
<input type=button onclick='document.getElementById("in").value=ex2.substring(1);' value="2." />
<input type=button onclick='document.getElementById("in").value=ex3.substring(1);' value="3." />
<input type=button onclick='document.getElementById("in").value=ex4.substring(1);' value="4." />
<input type=button onclick='document.getElementById("in").value=ex5.substring(1);' value="5." />
<input type=button onclick='document.getElementById("in").value=ex6.substring(1);' value="6." />
<input type=button onclick='document.getElementById("in").value=ex7.substring(1);' value="7." />
<input type=button onclick='document.getElementById("in").value=ex8.substring(1);' value="8." />
<input type=button onclick='document.getElementById("in").value=ex9.substring(1);' value="9." />
<input type=button onclick='document.getElementById("in").value=ex10.substring(1);' value="10." />
<input type=button onclick='document.getElementById("in").value=ex11.substring(1);' value="11." />
<input type=button onclick='document.getElementById("in").value=ex12.substring(1);' value="12." />
<input type=button onclick='document.getElementById("in").value=ex13.substring(1);' value="13." />
<table>
	<tr>
		<td>
			<textarea id="in" rows=15 cols=88 wrap='off' style="font-family: monospace !important;"># Simple example with defualt values and printing Script
1 Start()
2 XorGate()
3 Task()
4 AndGate()
5 Script("print(A.n,self.customer.attr)")
6 AndGate()
7 XorGate()
8 End()
1->2; 2->3;              3->7; 7->8;
      2->4;       4->6;  6->7;
	    4->5; 5->6;
			</textarea>
			<!--<script>document.getElementById("in").value=ex1.substring(1)</script>-->
		</td>
	</tr>
	<tr>
		<td>
			<input type=button value="Run" onclick="f(document.getElementById('in').value)">
			&nbsp;&nbsp;&nbsp;&nbsp;<a href="des.bpmn">Last run bpmn file (xml)</a>
			&nbsp;&nbsp;&nbsp;&nbsp;<a href="des.php?bpmn=des.bpmn">Last run bpmn file (preview)</a>
			&nbsp;&nbsp;&nbsp;&nbsp;<a href="des.php?dot=des.dot">Last run dot schemtic</a>
			<script>
				function f(s) {
					if(window.location.protocol.startsWith("file:")) {alert(s);return}
					url="des.php?ex="+encodeURIComponent(s);
					fetch(url, {cache:"reload"})
					.then(response => {return response.text();})
					.then(s => {
						document.getElementById("out").innerHTML=s;
					})
				}
			</script>
		</td>
	</tr>
	<tr>
		<td>
			<div id="out">
			
			</div>
		</td>
	</tr>
</table>
